<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>The permimp-package • permimp</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The permimp-package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">permimp</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1-0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/permimp-package.html">The permimp-package</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>The permimp-package</h1>
                        <h4 data-toc-skip class="author">Dries
Debeer</h4>
            <address class="author_afil">
      University of Zurich<br><h4 data-toc-skip class="date">2025-03-28</h4>
      

      <div class="d-none name"><code>permimp-package.Rmd</code></div>
    </address>
</div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      The <code>permimp</code>-package is developed to replace the
      Conditional Permutation Importance (CPI) computation by the
      <code>varimp</code>-function(s) of the <code>party</code>-package.
      <code>permimp</code> applies a different implementation for the
      CPI, in order to mitigate some issues related to the
      implementation of the CPI in the <code>party</code>-package. In
      addition, the CPI is also available for random forests grown by
      the <code>randomForest</code>-package. Finally, the package
      includes some plotting options.
    </div>
    
<hr>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Although originally designed for prediction purposes, Random forests
<span class="citation">Breiman (2001)</span> have become a popular tool
to assess the importance of predictors. Several methods and measures
have been proposed, one of the most popular ones is the <em>Permutation
Importance</em> <span class="citation">Breiman (2001)</span>, originally
referred to as the Mean Decrease in Accuracy. Inspired by the contrast
between the <em>unconditional</em> zero-order correlation between
predictor and outcome, and the <em>conditional</em> standardized
regression coefficient in multiple linear regression, <span class="citation">Strobl et al. (2008)</span> argued that in some cases
the importance of a predictor, conditionally on (all) other predictors,
may be of higher interest than the <em>unconditional</em> importance.
Therefore, they proposed the <em>Conditional Permutation
Importance</em>, which introduces a conditional permutation scheme that
is based on the dependence between the predictors.</p>
<p>The <code>permimp</code>-package presents a different implementation
of this <em>Conditional Permutation Importance</em>. Unlike the original
implementation (available in the <code>party</code> R-package of <span class="citation">Hothorn, Hornik, and Zeileis (2006)</span>),
<code>permimp</code> can, in addition to random forests that were grown
according to the unbiased recursive partitioning
(cf. <code>cforests</code>; <span class="citation">Hothorn, Hornik, and
Zeileis (2006)</span>), also deal with with random forests that were
grown using the <code>randomForest</code>-package <span class="citation">Liaw and Wiener (2002)</span>, which applies the
original tree growing algorithm based on impurity reduction <span class="citation">Breiman (2001)</span>. (In principle, the
<code>permimp</code> can be extended to random forests grown by other
packages, under the condition that tree-wise predictions are possible
and OOB-information as well as the split points are available per tree.)
We argue that the <code>permimp</code>-package can be seen as a
replacement for the <code>varimp</code>-functions of the
<code>party</code> package in R.</p>
<p>This vignette has two main parts. The first part is tutorial-like and
demonstrates functionality of the <code>permimp</code>-package (by also
comparing it to original <code><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">party::varimp</a></code>-functions. The
second part is more theoretical and explains the how and the why of the
new <em>Conditional Permutation Importance</em>-implementation.</p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="part-i-permimp-tutorial">Part I: <code>permimp</code>-tutorial<a class="anchor" aria-label="anchor" href="#part-i-permimp-tutorial"></a>
</h2>
<div class="section level3">
<h3 id="a--the-permimp-function">A. The <code>permimp</code>-function<a class="anchor" aria-label="anchor" href="#a--the-permimp-function"></a>
</h3>
<p>The <code>permimp</code>-function replaces all the
<code><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">party::varimp</a></code>-functions (<code>varimp</code>,
<code>varimpAUC</code>, <code>varimpsurv</code>). To apply
<code>permimp</code>-function, one needs a fitted random forest. Within
this tutorial we will mainly focus on random forests-objects as obtained
by the <code><a href="https://rdrr.io/pkg/party/man/cforest.html" class="external-link">party::cforest</a></code>-function (i.e., S4-objects of class
<code>"RandomForest"</code>). As an example we will use the (cleaned)
<code>airquality</code>-data set to fit random forest with 50 trees:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://party.R-forge.R-project.org" class="external-link">"party"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'zoo'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     as.Date, as.Date.numeric</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ddebeer.github.io/permimp/">"permimp"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">airq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/modeltools/man/ModelEnv-class.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">airquality</span>, <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Ozone</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Solar.R</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cfAirq50</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/cforest.html" class="external-link">cforest</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">airq</span>,</span>
<span>                    control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/cforest_control.html" class="external-link">cforest_unbiased</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fl">2</span>, ntree <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                              minbucket <span class="op">=</span> <span class="fl">5</span>, </span>
<span>                                              minsplit <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="a-1--new-conditional-permutation-importance">A.1. New Conditional Permutation Importance<a class="anchor" aria-label="anchor" href="#a-1--new-conditional-permutation-importance"></a>
</h4>
<p>Let’s start by comparing the <code>permimp</code> and the
<code>varimp</code> function for the conditional permutation
importance.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">CPI_permimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.180   0.014   0.194</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">CPI_varimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">varimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   1.288   0.005   1.294</span></span>
<span><span class="va">CPI_permimp</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  83.736656 209.786231 422.671385   1.820496  -7.668462</span></span>
<span><span class="va">CPI_varimp</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  25.147792 114.250197 220.080351   1.952776  -1.265111</span></span></code></pre></div>
<p>Three differences can easily be spotted:</p>
<ul>
<li>
<code>permimp</code> has a <code>progressBar</code>-argument. The
default is <code>progressBar = interactive()</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;&lt;code&gt;progressBar = FALSE&lt;/code&gt; was used, because a
progress bar is not represented well using R markdown.&lt;/p&gt;"><sup>1</sup></a>
</li>
<li>
<code>permimp</code> is faster than <code>varimp</code>.</li>
<li>The results are different.</li>
</ul>
</div>
<div class="section level4">
<h4 id="a-2--different-results">A.2. Different results?<a class="anchor" aria-label="anchor" href="#a-2--different-results"></a>
</h4>
<p>Why are the results different?</p>
<p>There are two main reasons.</p>
<p>First, <code>permimp</code> uses a different default
<code>threshold</code>-value: <code>permimp</code> uses
<code>threshold = .95</code> while <code>varimp</code> uses
<code>threshold = 0.2</code>. Check <code><a href="../reference/permimp.html">?permimp</a></code> and
<code><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">?varimp</a></code>. There is a good reason for using a higher default
threshold value.</p>
<p>When using equal <code>threshold</code>-values…</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CPI_permimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span>, threshold <span class="op">=</span> <span class="fl">.2</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">CPI_permimp</span></span>
<span><span class="co">#&gt;     Solar.R        Wind        Temp       Month         Day </span></span>
<span><span class="co">#&gt;  26.9974775 122.2781497 204.0238116  -3.1201748   0.8442593</span></span>
<span><span class="va">CPI_varimp</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  25.147792 114.250197 220.080351   1.952776  -1.265111</span></span></code></pre></div>
<p>The results are more similar, but not quite identical. The remaining
differences are explained by the second reason: the implementation of
<code>permimp</code> differs from the
<code>varimp</code>-implementation. Using a higher
<code>threshold</code>-value makes the differences between the two
implementations more pronounced.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CPI_varimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">varimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span>, threshold <span class="op">=</span> <span class="fl">.95</span><span class="op">)</span></span>
<span><span class="va">CPI_permimp</span></span>
<span><span class="co">#&gt;     Solar.R        Wind        Temp       Month         Day </span></span>
<span><span class="co">#&gt;  26.9974775 122.2781497 204.0238116  -3.1201748   0.8442593</span></span>
<span><span class="va">CPI_varimp</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  36.758973 198.610059 257.916926  -2.537016  -2.530303</span></span></code></pre></div>
<p>The differences between the two implementations (and why we believe
the new implementation is more attractive), is explained in the second
part of this document, as well as in this manuscript: <span class="citation">Debeer and Strobl (2020)</span>.</p>
</div>
<div class="section level4">
<h4 id="a-3--backward-compatible-with-party-when-asparty-true">A.3. Backward Compatible with <code>party</code> when:
<code>asParty = TRUE</code><a class="anchor" aria-label="anchor" href="#a-3--backward-compatible-with-party-when-asparty-true"></a>
</h4>
<p>By specifying <code>asParty = TRUE</code>, the
<code>permimp</code>-function can be made backward compatible with the
<code><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">party::varimp</a></code>-function. But <code>permimp</code> is a bit
faster. To get exactly the same results, the random seeds should be
exactly the same.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">CPI_asParty</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span>, asParty <span class="op">=</span> <span class="cn">TRUE</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   0.262   0.000   0.262</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">CPI_varimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">varimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;   1.269   0.000   1.269</span></span>
<span><span class="va">CPI_asParty</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  36.364271 136.732886 200.620728   3.179600   1.360632</span></span>
<span><span class="va">CPI_varimp</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  36.364271 136.732886 200.620728   3.179600   1.360632</span></span></code></pre></div>
<p>Note that with <code>asParty = TRUE</code> the default
<code>threshold</code>-value is automatically set back to
<code>0.2</code>.</p>
</div>
<div class="section level4">
<h4 id="a-4--different-output-varimp-object">A.4. Different Output: <code>VarImp</code>-object<a class="anchor" aria-label="anchor" href="#a-4--different-output-varimp-object"></a>
</h4>
<p>A less obvious difference between <code>permimp</code> and
<code>varimp</code> is the object that it returns. <code>permimp</code>
returns an S3-class object: <code>VarImp</code>, rather than a named
numerical vector. A <code>VarImp</code> object is a named list with four
elements:</p>
<ol style="list-style-type: decimal">
<li>
<code>$values</code>: holds the computed variable importance
values.</li>
<li>
<code>$perTree</code>: holds the variable importance values per tree
(averaged over the permutations when <code>nperm &gt; 1</code>).</li>
<li>
<code>$type</code>: the type of variable importance.</li>
<li>
<code>$info</code>: other relevant information about the variable
importance, such as the used <code>threshold</code>.</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## varimp returns a named numerical vector.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">CPI_varimp</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Named num [1:5] 36.36 136.73 200.62 3.18 1.36</span></span>
<span><span class="co">#&gt;  - attr(*, "names")= chr [1:5] "Solar.R" "Wind" "Temp" "Month" ...</span></span>
<span></span>
<span><span class="co">## permimp returns a VarImp-object.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">CPI_asParty</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 4</span></span>
<span><span class="co">#&gt;  $ values : Named num [1:5] 36.36 136.73 200.62 3.18 1.36</span></span>
<span><span class="co">#&gt;   ..- attr(*, "names")= chr [1:5] "Solar.R" "Wind" "Temp" "Month" ...</span></span>
<span><span class="co">#&gt;  $ perTree:'data.frame': 50 obs. of  5 variables:</span></span>
<span><span class="co">#&gt;   ..$ Solar.R: num [1:50] 117.35 0 1.81 0 58.22 ...</span></span>
<span><span class="co">#&gt;   ..$ Wind   : num [1:50] 118.8 430.7 141.5 171 78.1 ...</span></span>
<span><span class="co">#&gt;   ..$ Temp   : num [1:50] 374 433 118 -1 175 ...</span></span>
<span><span class="co">#&gt;   ..$ Month  : num [1:50] -4.59 0 34.93 -11.96 -11.9 ...</span></span>
<span><span class="co">#&gt;   ..$ Day    : num [1:50] 0 18.93 0 7.18 0 ...</span></span>
<span><span class="co">#&gt;  $ type   : chr "Conditional Permutation"</span></span>
<span><span class="co">#&gt;  $ info   :List of 4</span></span>
<span><span class="co">#&gt;   ..$ threshold   : num 0.2</span></span>
<span><span class="co">#&gt;   ..$ conditioning: chr "as party"</span></span>
<span><span class="co">#&gt;   ..$ outcomeType : chr "regression"</span></span>
<span><span class="co">#&gt;   ..$ errorType   : chr "MSE"</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr "VarImp"</span></span>
<span></span>
<span><span class="co">## the results of permimp(asParty = TRUE) and varimp() are exactly the same.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">CPI_asParty</span><span class="op">$</span><span class="va">values</span> <span class="op">==</span> <span class="va">CPI_varimp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>An advantage of the <code>VarImp</code>-object, is that the
<code>$perTree</code>-values can be used to inspect the distribution of
the importance values across the trees in a forest. For instance, the
plotting function (demonstrated below) can be used to visualize this
distribution of per tree importance values.</p>
</div>
<div class="section level4">
<h4 id="a-5--unconditional-permutation-importance-permimp-varimp">A.5. Unconditional Permutation Importance: <code>permimp</code> =
<code>varimp</code><a class="anchor" aria-label="anchor" href="#a-5--unconditional-permutation-importance-permimp-varimp"></a>
</h4>
<p>Of course, there is also the option to compute the unconditional
permutation importance. Both using the original and the split wise
permutation algorithm. Here, there are no differences between
<code>permimp</code> and <code>varimp</code>. That is,
<code>permimp</code> simply uses the <code>party</code>
<code>varimp</code> code, making the <code>asParty</code> argument
redundant in this case. Note, however, that <code>permimp</code> still
returns a <code>VarImp-object</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Original Unconditional Permutation Importance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">PI_permimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span>, pre1.0_0 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">PI_varimp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">varimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, pre1.0_0 <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">PI_permimp</span></span>
<span><span class="co">#&gt;      Solar.R         Wind         Temp        Month          Day </span></span>
<span><span class="co">#&gt; 104.19612764 345.36320352 582.09815801  18.04859049   0.01880503</span></span>
<span><span class="va">PI_varimp</span></span>
<span><span class="co">#&gt;      Solar.R         Wind         Temp        Month          Day </span></span>
<span><span class="co">#&gt; 104.19612764 345.36320352 582.09815801  18.04859049   0.01880503</span></span>
<span></span>
<span><span class="co">## Splitwise Unconditional Permutation Importance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">PI_permimp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">cfAirq50</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span>, oldSeedSelection <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">PI_varimp2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">varimp</a></span><span class="op">(</span><span class="va">cfAirq50</span><span class="op">)</span></span>
<span><span class="va">PI_permimp2</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  81.935250 451.459770 580.918085  21.851431  -4.613963</span></span>
<span><span class="va">PI_varimp2</span></span>
<span><span class="co">#&gt;    Solar.R       Wind       Temp      Month        Day </span></span>
<span><span class="co">#&gt;  81.935250 451.459770 580.918085  21.851431  -4.613963</span></span></code></pre></div>
<p>Note that the argument <code>oldSeedSelection = TRUE</code> was added
when using <code>permimp</code>. Since the release of version 1.1-0, the
way random seeds are used has been changed. Choosing
<code>oldSeedSelection = TRUE</code> makes the computations backward
compatible with older releases. However, when using parallel processing
the old selection of random seeds holds problems for reproducible
results. Hence, it is recommend to use the default
<code>oldSeedSelection = FALSE</code>, especially when using parallel
processing.</p>
<p>For more detailed information check <code><a href="../reference/permimp.html">?permimp</a></code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="b--methods-for-varimp-objects">B. Methods for <code>VarImp</code>-objects<a class="anchor" aria-label="anchor" href="#b--methods-for-varimp-objects"></a>
</h3>
<div class="section level4">
<h4 id="b-1--plot">B.1. <code>plot</code><a class="anchor" aria-label="anchor" href="#b-1--plot"></a>
</h4>
<p>Visualizing the variable importance values (as a
<code>VarImp</code>-object) is easy using the <code>plot</code> method.
Its main features include:</p>
<ul>
<li>Four plot types:`type = c(“bar”, “box”, “dot”, “rank”).</li>
<li>Predictors automatically ordered according to importance value (high
to low). Setting the argument <code>sort = FALSE</code> renders the
original order (cf. the <code>cforest</code> call).</li>
<li>with argument <code>horizontal = TRUE</code> horizontal plots are
made.</li>
<li>Optional visualization of the <code>$perTree</code> importance value
distribution with the <code>interval</code> argument. With
<code>type = "box"</code>, the distribution of the
<code>$perTree</code>-values is automatically visualized.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;This visualization is nicer when the &lt;code&gt;scales&lt;/code&gt;
package is installed.&lt;/p&gt;"><sup>2</sup></a>
</li>
</ul>
<p>We would suggest to only use the visualization of the
<code>$perTree</code> importance value distribution, when there are
enough trees (&gt;= 500) in the random forest. Therefore, we first fit a
new, bigger random forest, and compute the permutation importance.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## fit a new forest with 500 trees</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">cfAirq500</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/cforest.html" class="external-link">cforest</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">airq</span>,</span>
<span>                     control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/party/man/cforest_control.html" class="external-link">cforest_unbiased</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fl">2</span>, ntree <span class="op">=</span> <span class="fl">500</span>,</span>
<span>                                              minbucket <span class="op">=</span> <span class="fl">5</span>, </span>
<span>                                              minsplit <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## compute permutation importance</span></span>
<span><span class="va">PI_permimp500</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">cfAirq500</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## different plots, all easy to make</span></span>
<span><span class="co">## barplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">PI_permimp500</span>, type <span class="op">=</span> <span class="st">"bar"</span><span class="op">)</span></span></code></pre></div>
<p><img src="permimp-package_files/figure-html/barplot-1.png" alt="Barplot of Permutation Importance values." width="672"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## barplot with visualization of the distribution: an</span></span>
<span><span class="co">## interval between the .25 and .75 quantiles of the per </span></span>
<span><span class="co">## Tree values is added to the plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">PI_permimp500</span>, type <span class="op">=</span> <span class="st">"bar"</span>, interval <span class="op">=</span> <span class="st">"quantile"</span><span class="op">)</span></span></code></pre></div>
<p><img src="permimp-package_files/figure-html/barplot-quantiles-1.png" alt="Barplot of Permutation Importance values with quantile interval." width="672"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## horizontal boxplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">PI_permimp500</span>, type <span class="op">=</span> <span class="st">"box"</span>, horizontal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="permimp-package_files/figure-html/barplot-horizontal-1.png" alt="Horizontal barplot of Permutation Importance values." width="672"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## unsorted-dotplot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">PI_permimp500</span>, type <span class="op">=</span> <span class="st">"dot"</span>, sort <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>     interval <span class="op">=</span> <span class="st">"quantile"</span><span class="op">)</span></span></code></pre></div>
<p><img src="permimp-package_files/figure-html/dotplot%20unsorted-1.png" alt="Unsorted dotplot of Permutation Importance values." width="672"></p>
<div class="section level6">
<h6 id="additionally-you-can">Additionally you can:<a class="anchor" aria-label="anchor" href="#additionally-you-can"></a>
</h6>
<ul>
<li>Use your favorite colors with arguments <code>col</code> and
<code>intervalColor</code>.</li>
<li>Use different a quantile interval with
<code>intervalProbs = c(&lt;lower_quantile&gt;, &lt;upper_quantile&gt;)</code>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Only when &lt;code&gt;interval = "quantile"&lt;/code&gt;, which is
the default.&lt;/p&gt;'><sup>3</sup></a>
</li>
<li>Choose your own title the title with <code>main</code>
</li>
<li>Modify the margin with <code>margin</code>.</li>
</ul>
</div>
<div class="section level5">
<h5 id="although-we-would-advise-against-this-in-most-situations-you-can-also">Although we would advise against this in most situations, you can
also:<a class="anchor" aria-label="anchor" href="#although-we-would-advise-against-this-in-most-situations-you-can-also"></a>
</h5>
<ul>
<li>Plot only the <code>&lt;integer value&gt;</code> predictors with the
highest values with <code>nVar = &lt;integer value&gt;</code>.<br>
</li>
<li>Visualize the distribution using the standard deviation of the
<code>perTree</code> values with <code>interval = "sd"</code>. This is
almost always a bad idea, because it falsely suggests that the
distribution is symmetric. Please don’t use this option.</li>
</ul>
<p>For more detailed information check <code><a href="../reference/VarImp-methods.html">?plot.VarImp</a></code>.</p>
</div>
</div>
<div class="section level4">
<h4 id="b-2--other-varimp-methods">B.2. Other <code>VarImp</code>-methods<a class="anchor" aria-label="anchor" href="#b-2--other-varimp-methods"></a>
</h4>
<p>(Currently) there are three more <code>VarImp</code>-methods:</p>
<ul>
<li>
<code>print</code>: prints the <code>$values</code>
</li>
<li>
<code>ranks</code>: prints the (reverse) rankings of the
<code>$values</code>
</li>
<li>
<code>subset</code>: creates a subset that is itself also
a<code>VarImp</code>-object. Only to be used in very limited settings,
and when you know what you are doing.</li>
</ul>
<p>Other related functions are:</p>
<ul>
<li>
<code>as.VarImp</code>: creates a <code>VarImp</code>-object from a
<code>matrix</code>/<code>data.frame</code> of <code>perTree</code>
values, or from a numerical vector of importance values.</li>
<li>
<code>is.VarImp</code>: checks if an object is of the
<code>VarImp</code>-class.</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="c--permimp-applied-to-randomforest-objects">C. <code>permimp</code> applied to
<code>randomForest</code>-objects<a class="anchor" aria-label="anchor" href="#c--permimp-applied-to-randomforest-objects"></a>
</h3>
<p>As mentioned in the introduction, the <code>permimp</code>-package
can also deal with with random forests that were grown using the
<code>randomForest</code>-package <span class="citation">Liaw and Wiener
(2002)</span>, which applies the original tree growing algorithm based
on impurity reduction <span class="citation">Breiman (2001)</span>.</p>
<p>Let’s first grow a (small) forest.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">"randomForest"</a></span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; randomForest 4.7-1.2</span></span>
<span><span class="co">#&gt; Type rfNews() to see new features/changes/bug fixes.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">542863</span><span class="op">)</span></span>
<span><span class="va">rfAirq50</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">airq</span>, mtry <span class="op">=</span> <span class="fl">2</span>, replace <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                         nodesize <span class="op">=</span> <span class="fl">7</span>, keep.forest <span class="op">=</span> <span class="cn">TRUE</span>, keep.inbag <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Note that <code>keep.forest = TRUE</code> and
<code>keep.inbag = TRUE</code>. The <code>permimp</code>-function
requires information about which observations were in-bag (IB) or
out-of-bag (OOB), as well as information about the split points in each
tree. Without this information, the (Conditional) Permutation Importance
algorithm cannot be executed.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CPI_permimpRF</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/permimp.html">permimp</a></span><span class="op">(</span><span class="va">rfAirq50</span>, conditional <span class="op">=</span> <span class="cn">TRUE</span>, progressBar <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">CPI_permimpRF</span>, horizontal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="permimp-package_files/figure-html/randomforest-1.png" alt="Barplot of Conditional Permutation Importance values for a Random Forest by the RandomForest-package." width="672"></p>
<p>When calling <code>permimp</code> for a <code>randomForest</code>
object form the <code>randomForest</code>-package, a menu is prompted
that ask whether you are sure that the data-objects used to fit the
random forest have not changed. This is because the <code>permimp</code>
computations rely on those data-objects, and automatically search for
them in the environment. If these data-objects have changed, the
<code>permimp</code> results can be distorted.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="part-ii-new-conditional-permutation-implementation">Part II: New Conditional Permutation Implementation<a class="anchor" aria-label="anchor" href="#part-ii-new-conditional-permutation-implementation"></a>
</h2>
<p>This part explains the new implementation of the conditional
permutation importance, and discusses the differences with the original
implementation in <code>party</code>, as described by <span class="citation">Strobl et al. (2008)</span>. First the the idea behind
the conditional implementation is briefly recapitulated, followed by a
discussion of the original implementation. Then the new implementation
is explained, and the main differences with the original are emphasized.
Finally, some practical implications of the new implementation are
given, and the interpretation and possible use of the
<code>threshold</code> value are discussed.</p>
<div class="section level3">
<h3 id="a--recapitulation-conditional-permutation-importance-">A. Recapitulation: Conditional Permutation Importance.<a class="anchor" aria-label="anchor" href="#a--recapitulation-conditional-permutation-importance-"></a>
</h3>
<p>A researcher may be interested in whether a predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and the outcome
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
are independent. The “null-hypothesis” is then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mo stretchy="false" form="prefix">|</mo><mi>X</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(Y | X) = P(Y)</annotation></semantics></math>.
This corresponds with the unconditional permutation importance. When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
are indeed independent, permuting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
should not significantly change the prediction accuracy of the
tree/forest. The expected permutation importance value is zero.</p>
<p>However, a researcher may also be interested in the conditional
independence of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>,
conditionally on the values of some <em>other predictors</em>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>.
The “null-hypothesis” is then
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mo stretchy="false" form="prefix">|</mo><mi>X</mi><mo>,</mo><mi>Z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Y</mi><mo stretchy="false" form="prefix">|</mo><mi>Z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(Y | X, Z) = P(Y | Z)</annotation></semantics></math>.
Rather than “completely” permuting the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
values, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
values can be permuted conditionally, given their corresponding
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
values. This corresponds to the conditional permutation scheme. When
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
are conditionally independent, ideally, a conditional importance measure
should be zero.</p>
<p>If
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
are independent, both permutation schemes will give the same results. Or
in practice, similar importance values. Yet a dependence between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
will result in differences between the unconditional and the conditional
permutation schemes, and the corresponding importance values.</p>
<p><span class="citation">Strobl et al. (2008)</span> proposed to
specify a partitioning (grid) of the predictor space based on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
(for each tree), in order to (conditionally) permute the values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
withing each partition (i.e., cell in the grid). According to <span class="citation">Strobl et al. (2008)</span> this partitioning should
(1) be applicable to variables of all types; (2) be as parsimonious as
possible, but (3) be also computationally feasible. Therefore they
suggested to define the partitioning grid for each tree by means of the
partitions of the predictor space induced by that tree. More precisely,
using all the split points for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
in the tree,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
is discretized and the complete predictor space is partitioned using the
discretized
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>.</p>
<p>Note that this partitioning does not correspond with the recursive
partitioning of a tree. In a tree only the top node splits the complete
predictor space, all the following splits are conditional on the parent
nodes. In contrast, for the conditional permutation grid, all the split
points split the complete predictor space, which leads to a more
fine-grained grid.</p>
<p>In practice, the number of observations is finite. In situation with
a relatively low number of observations, the grid for the conditional
permutation may become to fine grained, making conditionally permuting
practically infeasible. Therefore, the selection of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
(the predictors to condition on) is not a sinecure.</p>
</div>
<div class="section level3">
<h3 id="b--original-implementation-partyvarimp">B. Original Implementation (<code>party::varimp</code>)<a class="anchor" aria-label="anchor" href="#b--original-implementation-partyvarimp"></a>
</h3>
<p>In their original implementation (cf, <code><a href="https://rdrr.io/pkg/party/man/varimp.html" class="external-link">party::varimp</a></code>),
<span class="citation">Strobl et al. (2008)</span> argued to only
include those variables in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
whose empirical correlation with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
exceeds a certain moderate threshold. For continuous variables the
Pearson correlation could be used, but for the general case they
proposed to use the conditional inference framework promoted by <span class="citation">Hothorn, Hornik, and Zeileis (2006)</span>. Applying
this framework provides <em>p</em>-values, which have the advantage that
they are comparable for variables of all types, and that they can serve
as an intuitive and objective means of selecting the variables Z to
condition on.</p>
<p>The original implementation can be described as follows:</p>
<blockquote>
<p>For every predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math></p>
<ol style="list-style-type: decimal">
<li>Test which other predictors are related to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
applying the conditional inference framework <span class="citation">(Hothorn et al. 2006)</span> using <strong>the full
data/training set</strong>.</li>
<li>Only include those other predictors in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
for which the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-value
of the test is smaller than <code>(1 - threshold)</code>.</li>
<li>Within each tree:
<ol style="list-style-type: decimal">
<li>Gather all the split points for every predictor in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>.</li>
<li>Discretize the predictors in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
using the gathered split points, and create a partitioning of the
predictor space.</li>
<li>Within each partition, permute the values of predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>.</li>
</ol>
</li>
</ol>
</blockquote>
<div class="section level4">
<h4 id="some-issues">Some issues<a class="anchor" aria-label="anchor" href="#some-issues"></a>
</h4>
<p>There are, however, two important issues with this
implementation:</p>
<ol style="list-style-type: decimal">
<li>For (some of) the tests in the conditional inference framework, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-values
not only depend on the strength of the (cor)relation, but also on the
sample size. For instance, in big samples small correlations can also
lead to small
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-values.</li>
<li>(Some of the tests in) the conditional inference framework only test
for linear dependence. For instance, for continuous variables a
correlation test is used. Of course, dependence between variables is not
limited to linear dependence. As a result, when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
are continuous and have a U-shaped independence structure,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
will not be included in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>.</li>
</ol>
</div>
</div>
<div class="section level3">
<h3 id="c--new-implementation-permimp-">C. New Implementation (<code>permimp</code>).<a class="anchor" aria-label="anchor" href="#c--new-implementation-permimp-"></a>
</h3>
<p>The new implementation tries to mitigate the two issues raised above,
by taking advantage of the fact that within each tree not the original
values of the predictors, but only the partitions are important for the
prediction of the outcome. That is, one can argue that the tree-based
partitioning rather than the original values should be used to decide
which <em>other</em> predictors should be included in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>.
Applying this rationale, the new implementation can be described as
follows:</p>
<blockquote>
<p><strong>In every tree</strong>, for every predictor with splits in
the tree:</p>
<ol style="list-style-type: decimal">
<li><p>Discretize the in-bag values for each predictor using the split
points:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
=&gt;
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>d</mi></msub><annotation encoding="application/x-tex">X_d</annotation></semantics></math>.</p></li>
<li>
<p>For every discretized
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>d</mi></msub><annotation encoding="application/x-tex">X_d</annotation></semantics></math>:</p>
<ol style="list-style-type: decimal">
<li>Test which other discretized predictors
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>d</mi></msub><annotation encoding="application/x-tex">W_d</annotation></semantics></math>
are related to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>d</mi></msub><annotation encoding="application/x-tex">X_d</annotation></semantics></math>,
applying a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>χ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math>-independence
tests (using only the in-bag values).</li>
<li>Only include those other predictors
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
for which the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-value
of the test is smaller than <code>(1 - threshold)</code>.</li>
<li>Create the partitioning of the predictor space using the discretized
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>.</li>
<li>Within each partition, permute the values of predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>.</li>
</ol>
</li>
</ol>
</blockquote>
<div class="section level4">
<h4 id="important-implications">Important implications<a class="anchor" aria-label="anchor" href="#important-implications"></a>
</h4>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>χ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math>-independence
test does not (directly) depend on sample size. Therefore, the new
implementation is less sensitive to the number of observations. In
addition, the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>χ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math>-independence
test is not limited to linear dependence. Hence, the new implementation
mitigates the two issue raised above. Because of this, the
<code>threshold</code>-value is easier to use and interpret (see
below).</p>
<p>Under the new implementation it is possible that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
differs across trees. Yet this is also the case under the original
implementation, since not all predictors in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
are used as splitting variable in each tree. In addition, due to the
randomness in random forests (subsampling/bootstrapping and
<code>mtry</code> selection), it is very unlikely that there are two
trees in the forest with exactly the same splitting points. Therefore,
the conditional sampling scheme almost surely differs across trees.</p>
</div>
</div>
<div class="section level3">
<h3 id="d--how-to-use-the-threshold-">D. How to Use the Threshold.<a class="anchor" aria-label="anchor" href="#d--how-to-use-the-threshold-"></a>
</h3>
<p>The <code>threshold</code>-value can be interpreted as a tuning
parameter to make the permutation more or less conditional. A
<code>threshold = 0</code> and a <code>threshold = 1</code>
corresponding to permuting as conditional as possible and permuting
completely unconditional, respectively. A <code>threshold = .95</code>,
the default in <code>permimp</code>, only includes those
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
for which
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>d</mi></msub><annotation encoding="application/x-tex">W_d</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>d</mi></msub><annotation encoding="application/x-tex">X_d</annotation></semantics></math>
are dependent (with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>-level
= .05).</p>
<p>Yet threshold values smaller than <code>threshold = .5</code>
generally make the selection of the predictors to condition on too
greedy, without a meaningful impact on the CPI pattern. Therefore, we
recommend using threshold values between .5 and 1.</p>
<p>Some research questions are best answered with a more marginal
importance measure, while other questions are better answered using a
more partial importance measure. In many situations, however, it is not
clear which measure best fits the research question. Therefore, we argue
that in these cases it can be interesting to evaluate the importance
(rankings) of the predictors for different
<code>threshold</code>-values. This strategy can provide more insight in
how the conditioning affects the permutation importance values.</p>
<p>In the original implementation, setting a sensible
<code>threshold</code> proved to be hard, because the practical meaning
of the <code>threshold</code> depended on the sample size and on the
type of variables (cf. the issues raised above). In the new
implementation, the <code>threshold</code>’s interpretation is clearer
and more stable. In addition, the simulation studies by <span class="citation">Debeer and Strobl (2020)</span> suggest that the new
implementation (a) allows a more gradual shift from unconditional to
conditional; and (b) gives more stable importance measure
computations.</p>
<p>As an additional feature, the <code>permimp</code> can provide some
diagnostics about the conditional permutation. When
<code>thresholdDiagnostics = TRUE</code>, the
<code>permimp</code>-function monitors whether or not a conditional
permutation scheme was feasible for each predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
in each tree. This information is translated in messages that suggest to
either or decrease the <code>threshold</code>.</p>
<p>First, it is possible that the conditioning grid is so fine-grained
that permuting
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
conditionally cannot lead to observations ending up in a different
end-node of the tree. In other words, the prediction accuracy before and
after permuting will be always equal. If this issue occurs in more than
50 percent of the trees that include
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
as a splitting variable, <code>permimp</code> will produce a note, and
suggest to increase the <code>threshold</code>-value. A higher
<code>threshold</code>-value may result in a less fine-grained
partitioning, making the conditional permutation feasible again.</p>
<p>Second, it is possible that there are no
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
in the tree for which the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>χ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math>-independence
test between
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>W</mi><mi>d</mi></msub><annotation encoding="application/x-tex">W_d</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>d</mi></msub><annotation encoding="application/x-tex">X_d</annotation></semantics></math>
is smaller than <code>(1 - threshold)</code>. This implies
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>
will be an empty set, and conditionally permuting is impossible. That
is, without a partitioning/grid, it is equal to unconditionally
permuting. If this issue occurs in more than 50 percent of the trees
that include
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
as a splitting variable, <code>permimp</code> will produce a note, and
suggest to decrease the <code>threshold</code>-value. A lower
<code>threshold</code>-value includes more
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>W</mi><annotation encoding="application/x-tex">W</annotation></semantics></math>
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math>,
making the conditional permutation feasible again.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<!--
# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\vspace*{-0.2in}
\noindent
-->
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Breiman2001" class="csl-entry">
Breiman, Leo. 2001. <span>“Random Forests.”</span> <em>Machine
Learning</em> 45 (1): 5–32. <a href="https://doi.org/10.1023/a:1010933404324" class="external-link">https://doi.org/10.1023/a:1010933404324</a>.
</div>
<div id="ref-Debeer2019" class="csl-entry">
Debeer, Dries, and Carolin Strobl. 2020. <span>“Conditional Permuation
Importance Revisited.”</span>
</div>
<div id="ref-Hothorn2006Lego" class="csl-entry">
Hothorn, Torsten, Kurt Hornik, Mark A van de Wiel, and Achim Zeileis.
2006. <span>“A Lego System for Conditional Inference.”</span> <em>The
American Statistician</em> 60 (August). https://doi.org/<a href="https://doi.org/10.1198/000313006X118430" class="external-link">https://doi.org/10.1198/000313006X118430</a>.
</div>
<div id="ref-Hothorn2006" class="csl-entry">
Hothorn, Torsten, Kurt Hornik, and Achim Zeileis. 2006. <span>“Unbiased
Recursive Partitioning: A Conditional Inference Framework.”</span>
<em>Journal of Computational and Graphical Statistics</em> 15 (3):
651–74. <a href="https://doi.org/10.1198/106186006x133933" class="external-link">https://doi.org/10.1198/106186006x133933</a>.
</div>
<div id="ref-Liaw2002" class="csl-entry">
Liaw, Andy, and Matthew Wiener. 2002. <span>“Classification and
Regression by randomForest.”</span> <em>R News</em> 2 (3): 18–22. <a href="https://CRAN.R-project.org/doc/Rnews/" class="external-link">https://CRAN.R-project.org/doc/Rnews/</a>.
</div>
<div id="ref-Strobl2008" class="csl-entry">
Strobl, Carolin, Anne-Laure Boulesteix, Thomas Kneib, Thomas Augustin,
and Achim Zeileis. 2008. <span>“Conditional Variable Importance for
Random Forests.”</span> <em><span>BMC</span> Bioinformatics</em> 9 (1):
307. <a href="https://doi.org/10.1186/1471-2105-9-307" class="external-link">https://doi.org/10.1186/1471-2105-9-307</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dries Debeer, Torsten Hothorn, Carolin Strobl.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
